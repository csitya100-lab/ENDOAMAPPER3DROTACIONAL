import { useRef, useState } from 'react';
import { useLocation } from 'wouter';
import { toast } from 'sonner';
import { Uterus3D, Uterus3DRef } from '@/components/Uterus3D';
import { AnatomyPanel } from '@/components/AnatomyPanel';
import { useLesionStore, Severity, Lesion } from '@/lib/lesionStore';
import { useReportStore } from '@/lib/reportStore';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Circle, RotateCcw, Clock, CheckCircle, AlertCircle, Settings2, FileText, Download, Camera, Share2, MousePointer2, Crosshair } from 'lucide-react';
import { export3DModelAsHtml } from '@/lib/export3DHtml';
import { getAnatomyLabel } from '@/lib/anatomyStore';
import { saveCaseToDb, isSupabaseConfigured } from '@/lib/caseDb';
import AppLayout from '@/components/AppLayout';
import { Slider } from '@/components/ui/slider';
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';

interface ExamInfo {
  patient: string;
  date: string;
  type: string;
}

export default function Home() {
  const [severity, setSeverity] = useState<Severity>('superficial');
  const [interactionMode, setInteractionMode] = useState<'navigate' | 'add'>('add');
  const [markerSize, setMarkerSize] = useState(0.18);
  const [markerColor, setMarkerColor] = useState<string | undefined>(undefined);
  const { lesions } = useLesionStore();
  const [examInfo] = useState<ExamInfo>({
    patient: 'Paciente A',
    date: new Date().toLocaleDateString('pt-BR'),
    type: 'Mapeamento EndoMapper',
  });
  const uterusRef = useRef<Uterus3DRef>(null);
  const [, setLocation] = useLocation();

  const handleClearLesions = () => {
    const savedLesions = [...lesions];
    uterusRef.current?.clearLesions();
    toast('Todas as lesões foram removidas', {
      action: {
        label: 'Desfazer',
        onClick: () => {
          savedLesions.forEach(l => useLesionStore.getState().addLesion(l));
          toast.success('Lesões restauradas');
        },
      },
      duration: 5000,
    });
  };

  const [isExporting, setIsExporting] = useState(false);
  const [isSaving, setIsSaving] = useState(false);

  const handleSaveAndShare = async () => {
    if (lesions.length === 0) {
      toast.warning('Adicione pelo menos uma lesão antes de salvar.');
      return;
    }
    if (!isSupabaseConfigured()) {
      toast.error('Supabase não está configurado. Configure as variáveis de ambiente.');
      return;
    }
    setIsSaving(true);
    try {
      const caseId = await saveCaseToDb({
        patient_name: examInfo.patient,
        exam_date: examInfo.date,
        lesions: lesions,
      });
      const shareUrl = `${window.location.origin}/view/${caseId}`;
      await navigator.clipboard.writeText(shareUrl);
      toast.success('Caso salvo! Link copiado para a área de transferência.', { description: shareUrl });
    } catch (error) {
      console.error('Erro ao salvar:', error);
      toast.error('Erro ao salvar o caso. Verifique a configuração do Supabase.');
    } finally {
      setIsSaving(false);
    }
  };

  const handleExportHtml = async () => {
    if (lesions.length === 0) {
      toast.warning('Adicione pelo menos uma lesão antes de exportar.');
      return;
    }
    setIsExporting(true);
    try {
      await export3DModelAsHtml(lesions);
    } catch (error) {
      console.error('Erro ao exportar:', error);
      toast.error('Erro ao exportar o modelo 3D. Tente novamente.');
    } finally {
      setIsExporting(false);
    }
  };

  const { 
    draftImages2D, 
    draftImages3D,
    createReport, 
    clearDraftImages2D, 
    clearDraftImages3D,
    addDraftImage3D 
  } = useReportStore();

  const handleCapture3D = () => {
    const imageData = uterusRef.current?.captureScreenshot();
    if (imageData) {
      addDraftImage3D(imageData);
      toast.success('Captura 3D adicionada!', { description: `${draftImages3D.length + 1} capturas no total` });
    } else {
      toast.error('Erro ao capturar a imagem. Tente novamente.');
    }
  };

  const handleGenerateReport = () => {
    uterusRef.current?.captureAllViews();
    
    const currentImages2D = useReportStore.getState().draftImages2D;
    const hasAny2D = currentImages2D['sagittal-avf'] || currentImages2D['sagittal-rvf'] || currentImages2D['coronal'] || currentImages2D['posterior'];
    const hasAny3D = draftImages3D.length > 0;
    
    if (!hasAny2D && !hasAny3D) {
      const proceed = confirm('Nenhuma imagem foi capturada. Deseja continuar mesmo assim?');
      if (!proceed) return;
    }

    const reportId = createReport({
      patientName: examInfo.patient,
      patientId: `PAC-${Date.now().toString(36).toUpperCase()}`,
      examDate: examInfo.date,
      examType: 'Mapeamento EndoMapper',
      images2D: {
        sagittal: currentImages2D['sagittal-avf'] || currentImages2D['sagittal-rvf'] || "",
        coronal: currentImages2D['coronal'] || "",
        posterior: currentImages2D['posterior'] || "",
      },
      imageNotes: {
        sagittal: "",
        coronal: "",
        posterior: "",
      },
      images3D: draftImages3D,
      lesions: lesions.map((l, idx) => ({
        id: l.id,
        name: `Lesão ${String.fromCharCode(65 + idx)}`,
        location: l.location ? getAnatomyLabel(l.location) : (l.severity === 'superficial' ? 'Região Superficial' : 'Região Profunda'),
        severity: l.severity,
        position: l.position
      })),
    });

    clearDraftImages2D();
    clearDraftImages3D();
    setLocation(`/relatorio/${reportId}`);
  };

  const getLesionCount = (sev: Severity) => lesions.filter(l => l.severity === sev).length;
  const lastLesion = lesions[lesions.length - 1];
  const lesionCount = lesions.length;

  const getMappingStatus = () => {
    if (lesionCount === 0) return 'Vazio';
    if (lesionCount < 3) return 'Em andamento';
    return 'Completo';
  };

  const getMappingStatusColor = (status: string) => {
    switch (status) {
      case 'Em andamento':
        return 'bg-blue-500/10 text-blue-600 border-blue-300 dark:text-blue-400 dark:border-blue-500/50';
      case 'Completo':
        return 'bg-green-500/10 text-green-600 border-green-300 dark:text-green-400 dark:border-green-500/50';
      case 'Vazio':
        return 'bg-slate-500/10 text-slate-600 border-slate-300 dark:text-slate-400 dark:border-slate-500/50';
      default:
        return 'bg-gray-500/10 text-gray-600 border-gray-300 dark:text-gray-400 dark:border-gray-500/50';
    }
  };

  const getMappingStatusIcon = (status: string) => {
    switch (status) {
      case 'Em andamento':
        return <Clock className="w-3.5 h-3.5" />;
      case 'Completo':
        return <CheckCircle className="w-3.5 h-3.5" />;
      default:
        return <AlertCircle className="w-3.5 h-3.5" />;
    }
  };

  const getLesionStatus = (index: number) => {
    return index === lesions.length - 1 ? 'Recém adicionada' : 'Mapeada';
  };

  const getLesionStatusColor = (status: string) => {
    switch (status) {
      case 'Recém adicionada':
        return 'bg-blue-500/10 text-blue-600 border-blue-300 dark:text-blue-400 dark:border-blue-500/50';
      case 'Mapeada':
        return 'bg-green-500/10 text-green-600 border-green-300 dark:text-green-400 dark:border-green-500/50';
      default:
        return 'bg-gray-500/10 text-gray-600 border-gray-300 dark:text-gray-400 dark:border-gray-500/50';
    }
  };

  const getLesionStatusIcon = (status: string) => {
    switch (status) {
      case 'Recém adicionada':
        return <Clock className="w-3 h-3" />;
      case 'Mapeada':
        return <CheckCircle className="w-3 h-3" />;
      default:
        return <AlertCircle className="w-3 h-3" />;
    }
  };

  return (
    <AppLayout>
      <div className="flex flex-col h-full overflow-hidden">
        <header className="flex-none h-16 border-b border-slate-200 bg-white shadow-sm px-6 flex items-center justify-between z-20 dark:bg-slate-900 dark:border-slate-700 dark:shadow-none">
          <div className="flex items-center gap-3">
            <div className="flex items-center gap-3">
               <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-pink-500 to-rose-600 flex items-center justify-center">
                 <span className="text-white font-bold text-sm">3D</span>
               </div>
               <h1 className="text-xl font-bold tracking-tight text-slate-900 font-sans dark:text-white">
                 Endo<span className="text-rose-600 dark:text-rose-400">Mapper</span>
               </h1>
            </div>

            <div className="h-8 w-px bg-slate-200 hidden sm:block dark:bg-slate-700" />

            <div className="flex items-center gap-1 bg-slate-100 p-1 rounded-lg border border-slate-200 dark:bg-slate-800 dark:border-slate-700">
              <button
                onClick={() => setInteractionMode('navigate')}
                className={`px-3 py-1.5 rounded-md text-xs font-medium flex items-center gap-1.5 transition-all ${
                  interactionMode === 'navigate' 
                    ? 'bg-white text-slate-900 shadow-sm border border-slate-200 dark:bg-slate-700 dark:text-white dark:border-slate-600' 
                    : 'text-slate-500 hover:text-slate-700 dark:text-slate-300 dark:hover:text-white dark:hover:bg-slate-700'
                }`}
                data-testid="button-mode-navigate"
                aria-label="Modo navegação"
              >
                <MousePointer2 className="w-3.5 h-3.5" />
                Navegar
              </button>
              <button
                onClick={() => setInteractionMode('add')}
                className={`px-3 py-1.5 rounded-md text-xs font-medium flex items-center gap-1.5 transition-all ${
                  interactionMode === 'add' 
                    ? 'bg-pink-100 text-pink-700 border border-pink-300 dark:bg-pink-500/20 dark:text-pink-400 dark:border-pink-500/50' 
                    : 'text-slate-500 hover:text-slate-700 dark:text-slate-300 dark:hover:text-white dark:hover:bg-slate-700'
                }`}
                data-testid="button-mode-add"
                aria-label="Modo marcação de lesão"
              >
                <Crosshair className="w-3.5 h-3.5" />
                Marcar
              </button>
            </div>

            <div className="h-8 w-px bg-slate-200 hidden sm:block dark:bg-slate-700" />

            <div className="flex items-center gap-1 bg-slate-100 p-1 rounded-lg border border-slate-200 dark:bg-slate-800 dark:border-slate-700">
              <button
                onClick={() => setSeverity('superficial')}
                className={`
                  px-3 py-1.5 rounded-md text-xs font-medium flex items-center gap-2 transition-all
                  ${severity === 'superficial' 
                    ? 'bg-red-100 text-red-700 border border-red-300 dark:bg-red-500/20 dark:text-red-400 dark:border-red-500/50' 
                    : 'text-slate-600 hover:text-slate-900 hover:bg-white dark:text-slate-300 dark:hover:text-white dark:hover:bg-slate-700'}
                `}
              >
                <div className={`w-2 h-2 rounded-full ${severity === 'superficial' ? 'bg-red-500' : 'bg-slate-400'}`} />
                Superficial
              </button>
              <button
                onClick={() => setSeverity('deep')}
                className={`
                  px-3 py-1.5 rounded-md text-xs font-medium flex items-center gap-2 transition-all
                  ${severity === 'deep' 
                    ? 'bg-blue-100 text-blue-700 border border-blue-300 dark:bg-blue-500/20 dark:text-blue-400 dark:border-blue-500/50' 
                    : 'text-slate-600 hover:text-slate-900 hover:bg-white dark:text-slate-300 dark:hover:text-white dark:hover:bg-slate-700'}
                `}
              >
                <div className={`w-2 h-2 rounded-full ${severity === 'deep' ? 'bg-blue-500' : 'bg-slate-400'}`} />
                Profunda
              </button>
            </div>

            <Popover>
              <PopoverTrigger asChild>
                <Button variant="outline" size="sm" className="h-9 gap-2 bg-slate-100 border-slate-200 text-slate-700 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-300">
                  <Settings2 className="w-4 h-4" />
                  <span className="text-xs font-medium">Marcador</span>
                </Button>
              </PopoverTrigger>
              <PopoverContent className="w-64 p-4" align="start">
                <div className="space-y-4">
                  <div>
                    <label className="text-xs font-medium text-slate-700 mb-2 block dark:text-slate-300">Tamanho: {markerSize.toFixed(2)}</label>
                    <Slider
                      value={[markerSize]}
                      onValueChange={([v]) => setMarkerSize(v)}
                      min={0.08}
                      max={0.5}
                      step={0.02}
                      className="w-full"
                      data-testid="slider-marker-size"
                    />
                  </div>
                  <div>
                    <label className="text-xs font-medium text-slate-700 mb-2 block dark:text-slate-300">Cor personalizada</label>
                    <div className="flex items-center gap-2">
                      <input
                        type="color"
                        value={markerColor || '#ef4444'}
                        onChange={(e) => setMarkerColor(e.target.value)}
                        className="w-10 h-8 cursor-pointer rounded border border-slate-300"
                        data-testid="input-marker-color"
                      />
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => setMarkerColor(undefined)}
                        className="text-xs h-8"
                        data-testid="button-reset-color"
                      >
                        Usar cor padrão
                      </Button>
                    </div>
                  </div>
                </div>
              </PopoverContent>
            </Popover>
          </div>

          <div className="flex items-center gap-3">
            <div className="flex items-center gap-4 pr-3 border-r border-slate-200 dark:border-slate-700">
              <div className="text-right">
                <p className="text-sm font-semibold text-slate-900 dark:text-white">{examInfo.patient}</p>
                <p className="text-xs text-slate-600 dark:text-slate-400">{examInfo.type}</p>
                <p className="text-[10px] text-slate-500 mt-0.5 dark:text-slate-500">{examInfo.date}</p>
              </div>
            </div>

            <Badge variant="outline" className="font-mono hidden sm:flex bg-slate-100 border-slate-200 text-slate-700 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-300">
              {lesionCount} lesão{lesionCount !== 1 ? 's' : ''}
            </Badge>

            <div className="h-8 w-px bg-slate-200 dark:bg-slate-700" />

            <Button 
              size="sm" 
              onClick={handleCapture3D}
              className="text-xs h-9 bg-purple-600 text-white hover:bg-purple-700 border border-purple-500"
              data-testid="button-capture-3d"
            >
              <Camera className="w-3.5 h-3.5 mr-1.5" />
              Capturar 3D
            </Button>

            <div className="h-8 w-px bg-slate-200 dark:bg-slate-700" />

            <div className="flex items-center gap-2">
              <Button 
                size="sm" 
                onClick={handleExportHtml}
                disabled={isExporting}
                className="text-xs h-9 bg-emerald-600 text-white hover:bg-emerald-700 border border-emerald-500"
                data-testid="button-export-3d"
              >
                <Download className="w-3.5 h-3.5 mr-1.5" />
                {isExporting ? 'Exportando...' : 'Exportar 3D'}
              </Button>

              <Button 
                size="sm" 
                onClick={handleSaveAndShare}
                disabled={isSaving}
                className="text-xs h-9 bg-cyan-600 text-white hover:bg-cyan-700 border border-cyan-500"
                data-testid="button-save-share"
              >
                <Share2 className="w-3.5 h-3.5 mr-1.5" />
                {isSaving ? 'Salvando...' : 'Salvar & Compartilhar'}
              </Button>

              <Button 
                size="sm" 
                onClick={handleGenerateReport}
                className="text-xs h-9 bg-indigo-600 text-white hover:bg-indigo-700 border border-indigo-500"
              >
                <FileText className="w-3.5 h-3.5 mr-1.5" />
                Gerar Relatório
              </Button>
            </div>

            <div className="h-8 w-px bg-slate-200 dark:bg-slate-700" />

            <Button 
              size="sm" 
              onClick={handleClearLesions}
              className="text-xs h-9 bg-red-50 text-red-600 hover:bg-red-100 border border-red-200 dark:bg-red-500/10 dark:text-red-400 dark:hover:bg-red-500/20 dark:border-red-500/30"
              variant="outline"
            >
              <RotateCcw className="w-3.5 h-3.5 mr-1.5" />
              Limpar
            </Button>
          </div>
        </header>

        <div className="flex-1 flex overflow-hidden">
          <main className="flex-1 relative">
            <Uterus3D 
              ref={uterusRef}
              severity={severity}
              markerSize={markerSize}
              markerColor={markerColor}
              markerType="circle"
              interactionMode={interactionMode}
              onLesionCountChange={() => {}}
              onLesionsUpdate={() => {}}
            />
          </main>

          <aside className="w-72 border-l border-slate-200 bg-white shadow-sm overflow-y-auto dark:bg-slate-900 dark:border-slate-700">
            <div className="p-4 border-b border-slate-200 dark:border-slate-700">
              <div className="flex items-center justify-between mb-3">
                <h2 className="text-sm font-bold text-slate-900 tracking-wide dark:text-white">
                  RESUMO DE MAPEAMENTO
                </h2>
                <div className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full border text-[10px] font-medium ${getMappingStatusColor(getMappingStatus())}`}>
                  {getMappingStatusIcon(getMappingStatus())}
                  {getMappingStatus()}
                </div>
              </div>
              <div className="space-y-2">
                <div className="flex items-center justify-between p-3 rounded-lg bg-red-50 border border-red-200 dark:bg-red-500/10 dark:border-red-500/30">
                  <span className="text-xs text-slate-600 flex items-center gap-2 font-medium dark:text-slate-300">
                    <Circle className="w-2.5 h-2.5 fill-red-500 text-red-500" />
                    Superficial
                  </span>
                  <span className="text-sm font-bold text-red-600 dark:text-red-400">{getLesionCount('superficial')}</span>
                </div>
                <div className="flex items-center justify-between p-3 rounded-lg bg-blue-50 border border-blue-200 dark:bg-blue-500/10 dark:border-blue-500/30">
                  <span className="text-xs text-slate-600 flex items-center gap-2 font-medium dark:text-slate-300">
                    <Circle className="w-2.5 h-2.5 fill-blue-500 text-blue-500" />
                    Profunda
                  </span>
                  <span className="text-sm font-bold text-blue-600 dark:text-blue-400">{getLesionCount('deep')}</span>
                </div>
                <div className="pt-2 border-t border-slate-200 mt-2 dark:border-slate-700">
                  <span className="text-xs text-slate-600 font-medium dark:text-slate-300">Total de Lesões</span>
                  <span className="text-2xl font-bold text-slate-900 block dark:text-white">{lesionCount}</span>
                </div>
              </div>
            </div>

            <div className="p-4">
              <h3 className="text-xs font-bold text-slate-900 tracking-wide mb-3 dark:text-white">
                ESTRUTURAS ANATÔMICAS
              </h3>
              <AnatomyPanel />
            </div>
          </aside>
        </div>
      </div>
    </AppLayout>
  );
}
